//! Opset 1 compliance tests.
//!
//! Auto-generated by gen_rust_tests.py. Edit the generator, not this file.

use super::helpers::*;

#[test]
fn and_op() {
    let graph = load_model("opset_01.onnx");
    let node = find_node(&graph, "and");
    insta::assert_snapshot!(format!("{node:#?}"), @r#"
    And(
        AndNode {
            name: "and1",
            inputs: [
                Argument {
                    name: "and_a",
                    ty: Tensor(
                        TensorType {
                            dtype: Bool,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
                Argument {
                    name: "and_b",
                    ty: Tensor(
                        TensorType {
                            dtype: Bool,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            outputs: [
                Argument {
                    name: "and1_out1",
                    ty: Tensor(
                        TensorType {
                            dtype: Bool,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
        },
    )
    "#);
}

#[test]
fn cast() {
    let graph = load_model("opset_01.onnx");
    let node = find_node(&graph, "cast");
    insta::assert_snapshot!(format!("{node:#?}"), @r#"
    Cast(
        CastNode {
            name: "cast1",
            inputs: [
                Argument {
                    name: "cast_input",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 2,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            outputs: [
                Argument {
                    name: "cast1_out1",
                    ty: Tensor(
                        TensorType {
                            dtype: I32,
                            rank: 2,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            config: CastConfig {
                to: I32,
            },
        },
    )
    "#);
}

#[test]
fn constant() {
    let graph = load_model("opset_01.onnx");
    let node = find_node(&graph, "constant");
    insta::assert_snapshot!(format!("{node:#?}"), @r#"
    Constant(
        ConstantNode {
            name: "constant5",
            inputs: [
                Argument {
                    name: "",
                    ty: Tensor(
                        TensorType {
                            dtype: I64,
                            rank: 1,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Static(
                        4,
                    ),
                },
            ],
            outputs: [
                Argument {
                    name: "constant5_out1",
                    ty: Tensor(
                        TensorType {
                            dtype: I64,
                            rank: 1,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Constant,
                },
            ],
        },
    )
    "#);
}

#[test]
fn conv() {
    let graph = load_model("opset_01.onnx");
    let node = find_node(&graph, "conv2d");
    insta::assert_snapshot!(format!("{node:#?}"), @r#"
    Conv2d(
        Conv2dNode {
            name: "conv2d1",
            inputs: [
                Argument {
                    name: "conv_input",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 4,
                            static_shape: Some(
                                [
                                    Some(
                                        1,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        5,
                                    ),
                                    Some(
                                        5,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
                Argument {
                    name: "",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 4,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        3,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Static(
                        0,
                    ),
                },
            ],
            outputs: [
                Argument {
                    name: "conv2d1_out1",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 4,
                            static_shape: Some(
                                [
                                    Some(
                                        1,
                                    ),
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        3,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            config: Conv2dConfig {
                kernel_size: [
                    3,
                    3,
                ],
                stride: [
                    1,
                    1,
                ],
                padding: Valid,
                dilation: [
                    1,
                    1,
                ],
                groups: 1,
                auto_pad: NotSet,
            },
        },
    )
    "#);
}

#[test]
fn conv_transpose() {
    let graph = load_model("opset_01.onnx");
    let node = find_node(&graph, "convtranspose2d");
    insta::assert_snapshot!(format!("{node:#?}"), @r#"
    ConvTranspose2d(
        ConvTranspose2dNode {
            name: "convtranspose2d1",
            inputs: [
                Argument {
                    name: "convtranspose_input",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 4,
                            static_shape: Some(
                                [
                                    Some(
                                        1,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        5,
                                    ),
                                    Some(
                                        5,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
                Argument {
                    name: "",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 4,
                            static_shape: Some(
                                [
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        3,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Static(
                        1,
                    ),
                },
            ],
            outputs: [
                Argument {
                    name: "convtranspose2d1_out1",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 4,
                            static_shape: Some(
                                [
                                    Some(
                                        1,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        5,
                                    ),
                                    Some(
                                        5,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            config: ConvTranspose2dConfig {
                kernel_size: [
                    3,
                    3,
                ],
                stride: [
                    1,
                    1,
                ],
                dilation: [
                    1,
                    1,
                ],
                padding: [
                    0,
                    0,
                ],
                padding_out: [
                    0,
                    0,
                ],
                groups: 1,
            },
        },
    )
    "#);
}

#[test]
fn depth_to_space() {
    let graph = load_model("opset_01.onnx");
    let node = find_node(&graph, "depthtospace");
    insta::assert_snapshot!(format!("{node:#?}"), @r#"
    DepthToSpace(
        DepthToSpaceNode {
            name: "depthtospace1",
            inputs: [
                Argument {
                    name: "depthtospace_input",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 4,
                            static_shape: Some(
                                [
                                    Some(
                                        1,
                                    ),
                                    Some(
                                        8,
                                    ),
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        2,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            outputs: [
                Argument {
                    name: "depthtospace1_out1",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 4,
                            static_shape: Some(
                                [
                                    Some(
                                        1,
                                    ),
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        4,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            config: DepthToSpaceConfig {
                mode: Dcr,
                block_size: 2,
            },
        },
    )
    "#);
}

/// Dropout is eliminated during post-processing (no-op).
/// Verify the model parses without error.
#[test]
fn dropout() {
    let _graph = load_model("opset_01.onnx");
}

#[test]
fn elu() {
    let graph = load_model("opset_01.onnx");
    let node = find_node(&graph, "elu");
    insta::assert_snapshot!(format!("{node:#?}"), @r#"
    Elu(
        EluNode {
            name: "elu1",
            inputs: [
                Argument {
                    name: "elu_input",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            outputs: [
                Argument {
                    name: "elu1_out1",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            config: EluConfig {
                alpha: 1.0,
            },
        },
    )
    "#);
}

#[test]
fn flatten() {
    let graph = load_model("opset_01.onnx");
    let node = find_node(&graph, "flatten");
    insta::assert_snapshot!(format!("{node:#?}"), @r#"
    Flatten(
        FlattenNode {
            name: "flatten1",
            inputs: [
                Argument {
                    name: "flatten_input",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            outputs: [
                Argument {
                    name: "flatten1_out1",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 2,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        12,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            config: FlattenConfig {
                axis: 1,
            },
        },
    )
    "#);
}

#[test]
fn gru() {
    let graph = load_model("opset_01.onnx");
    let node = find_node(&graph, "gru");
    insta::assert_snapshot!(format!("{node:#?}"), @r#"
    Gru(
        GruNode {
            name: "gru1",
            inputs: [
                Argument {
                    name: "gru_input",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        1,
                                    ),
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
                Argument {
                    name: "",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        1,
                                    ),
                                    Some(
                                        12,
                                    ),
                                    Some(
                                        3,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Static(
                        2,
                    ),
                },
                Argument {
                    name: "",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        1,
                                    ),
                                    Some(
                                        12,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Static(
                        3,
                    ),
                },
            ],
            outputs: [
                Argument {
                    name: "gru1_out1",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 4,
                            static_shape: None,
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            config: GruConfig {
                input_size: 3,
                hidden_size: 4,
                direction: Forward,
                has_bias: false,
                has_initial_h: false,
                batch_first: false,
                clip: None,
                linear_before_reset: false,
                gate_activation: Sigmoid,
                hidden_activation: Tanh,
                activation_alpha: None,
                activation_beta: None,
            },
        },
    )
    "#);
}

#[test]
fn gather() {
    let graph = load_model("opset_01.onnx");
    let node = find_node(&graph, "gather");
    insta::assert_snapshot!(format!("{node:#?}"), @r#"
    Gather(
        GatherNode {
            name: "gather1",
            inputs: [
                Argument {
                    name: "gather_input",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 2,
                            static_shape: Some(
                                [
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
                Argument {
                    name: "constant5_out1",
                    ty: Tensor(
                        TensorType {
                            dtype: I64,
                            rank: 1,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Constant,
                },
            ],
            outputs: [
                Argument {
                    name: "gather1_out1",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 2,
                            static_shape: None,
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            config: GatherConfig {
                axis: 0,
            },
        },
    )
    "#);
}

#[test]
fn global_average_pool() {
    let graph = load_model("opset_01.onnx");
    let node = find_node(&graph, "globalaveragepool");
    insta::assert_snapshot!(format!("{node:#?}"), @r#"
    GlobalAveragePool(
        GlobalAveragePoolNode {
            name: "globalaveragepool1",
            inputs: [
                Argument {
                    name: "globalaveragepool_input",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 4,
                            static_shape: Some(
                                [
                                    Some(
                                        1,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        8,
                                    ),
                                    Some(
                                        8,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            outputs: [
                Argument {
                    name: "globalaveragepool1_out1",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 4,
                            static_shape: Some(
                                [
                                    Some(
                                        1,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        8,
                                    ),
                                    Some(
                                        8,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
        },
    )
    "#);
}

/// Identity is eliminated during post-processing (no-op).
/// Verify the model parses without error.
#[test]
fn identity() {
    let _graph = load_model("opset_01.onnx");
}

#[test]
fn if_op() {
    let graph = load_model("opset_01.onnx");
    let node = find_node(&graph, "if");
    insta::assert_snapshot!(format!("{node:#?}"), @r#"
    If(
        IfNode {
            name: "if1",
            inputs: [
                Argument {
                    name: "if_condition",
                    ty: Scalar(
                        Bool,
                    ),
                    value_source: Dynamic,
                },
            ],
            outputs: [
                Argument {
                    name: "if1_out1",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 2,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            config: IfConfig {
                then_branch: OnnxGraph {
                    nodes: [
                        Constant(
                            ConstantNode {
                                name: "constant12",
                                inputs: [
                                    Argument {
                                        name: "",
                                        ty: Tensor(
                                            TensorType {
                                                dtype: F32,
                                                rank: 2,
                                                static_shape: Some(
                                                    [
                                                        Some(
                                                            2,
                                                        ),
                                                        Some(
                                                            3,
                                                        ),
                                                    ],
                                                ),
                                            },
                                        ),
                                        value_source: Static(
                                            0,
                                        ),
                                    },
                                ],
                                outputs: [
                                    Argument {
                                        name: "constant12_out1",
                                        ty: Tensor(
                                            TensorType {
                                                dtype: F32,
                                                rank: 2,
                                                static_shape: Some(
                                                    [
                                                        Some(
                                                            2,
                                                        ),
                                                        Some(
                                                            3,
                                                        ),
                                                    ],
                                                ),
                                            },
                                        ),
                                        value_source: Constant,
                                    },
                                ],
                            },
                        ),
                    ],
                    inputs: [],
                    outputs: [
                        Argument {
                            name: "constant12_out1",
                            ty: Tensor(
                                TensorType {
                                    dtype: F32,
                                    rank: 2,
                                    static_shape: Some(
                                        [
                                            Some(
                                                2,
                                            ),
                                            Some(
                                                3,
                                            ),
                                        ],
                                    ),
                                },
                            ),
                            value_source: Constant,
                        },
                    ],
                    value_store: Some(
                        ValueStore {
                            tensor_store: TensorStore {
                                data: {
                                    0: TensorDataRef {
                                        shape: [
                                            2,
                                            3,
                                        ],
                                        dtype: F32,
                                        source: Embedded(
                                            b"\0\0\x80?\0\0\x80?\0\0\x80?\0\0\x80?\0\0\x80?\0\0\x80?",
                                        ),
                                    },
                                },
                                next_id: 1,
                            },
                            constant_map: {
                                "constant12_out1": 0,
                            },
                        },
                    ),
                },
                else_branch: OnnxGraph {
                    nodes: [
                        Constant(
                            ConstantNode {
                                name: "constant13",
                                inputs: [
                                    Argument {
                                        name: "",
                                        ty: Tensor(
                                            TensorType {
                                                dtype: F32,
                                                rank: 2,
                                                static_shape: Some(
                                                    [
                                                        Some(
                                                            2,
                                                        ),
                                                        Some(
                                                            3,
                                                        ),
                                                    ],
                                                ),
                                            },
                                        ),
                                        value_source: Static(
                                            0,
                                        ),
                                    },
                                ],
                                outputs: [
                                    Argument {
                                        name: "constant13_out1",
                                        ty: Tensor(
                                            TensorType {
                                                dtype: F32,
                                                rank: 2,
                                                static_shape: Some(
                                                    [
                                                        Some(
                                                            2,
                                                        ),
                                                        Some(
                                                            3,
                                                        ),
                                                    ],
                                                ),
                                            },
                                        ),
                                        value_source: Constant,
                                    },
                                ],
                            },
                        ),
                    ],
                    inputs: [],
                    outputs: [
                        Argument {
                            name: "constant13_out1",
                            ty: Tensor(
                                TensorType {
                                    dtype: F32,
                                    rank: 2,
                                    static_shape: Some(
                                        [
                                            Some(
                                                2,
                                            ),
                                            Some(
                                                3,
                                            ),
                                        ],
                                    ),
                                },
                            ),
                            value_source: Constant,
                        },
                    ],
                    value_store: Some(
                        ValueStore {
                            tensor_store: TensorStore {
                                data: {
                                    0: TensorDataRef {
                                        shape: [
                                            2,
                                            3,
                                        ],
                                        dtype: F32,
                                        source: Embedded(
                                            b"\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0",
                                        ),
                                    },
                                },
                                next_id: 1,
                            },
                            constant_map: {
                                "constant13_out1": 0,
                            },
                        },
                    ),
                },
                scope_ref_names: [],
            },
        },
    )
    "#);
}

#[test]
fn lstm() {
    let graph = load_model("opset_01.onnx");
    let node = find_node(&graph, "lstm");
    insta::assert_snapshot!(format!("{node:#?}"), @r#"
    Lstm(
        LstmNode {
            name: "lstm1",
            inputs: [
                Argument {
                    name: "lstm_input",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        1,
                                    ),
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
                Argument {
                    name: "",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        1,
                                    ),
                                    Some(
                                        16,
                                    ),
                                    Some(
                                        3,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Static(
                        5,
                    ),
                },
                Argument {
                    name: "",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        1,
                                    ),
                                    Some(
                                        16,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Static(
                        6,
                    ),
                },
            ],
            outputs: [
                Argument {
                    name: "lstm1_out1",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 4,
                            static_shape: None,
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            config: LstmConfig {
                input_size: 3,
                hidden_size: 4,
                direction: Forward,
                has_bias: false,
                has_initial_h: false,
                has_initial_c: false,
                has_peephole: false,
                batch_first: false,
                clip: None,
                input_forget: false,
                gate_activation: Sigmoid,
                cell_activation: Tanh,
                hidden_activation: Tanh,
            },
        },
    )
    "#);
}

#[test]
fn mat_mul() {
    let graph = load_model("opset_01.onnx");
    let node = find_node(&graph, "matmul");
    insta::assert_snapshot!(format!("{node:#?}"), @r#"
    MatMul(
        MatMulNode {
            name: "matmul1",
            inputs: [
                Argument {
                    name: "matmul_a",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 2,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
                Argument {
                    name: "matmul_b",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 2,
                            static_shape: Some(
                                [
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            outputs: [
                Argument {
                    name: "matmul1_out1",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 2,
                            static_shape: None,
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
        },
    )
    "#);
}

#[test]
fn max() {
    let graph = load_model("opset_01.onnx");
    let node = find_node(&graph, "max");
    insta::assert_snapshot!(format!("{node:#?}"), @r#"
    Max(
        MaxNode {
            name: "max1",
            inputs: [
                Argument {
                    name: "max_a",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
                Argument {
                    name: "max_b",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            outputs: [
                Argument {
                    name: "max1_out1",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
        },
    )
    "#);
}

#[test]
fn max_pool() {
    let graph = load_model("opset_01.onnx");
    let node = find_node(&graph, "maxpool2d");
    insta::assert_snapshot!(format!("{node:#?}"), @r#"
    MaxPool2d(
        MaxPool2dNode {
            name: "maxpool2d1",
            inputs: [
                Argument {
                    name: "maxpool_input",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 4,
                            static_shape: Some(
                                [
                                    Some(
                                        1,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        8,
                                    ),
                                    Some(
                                        8,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            outputs: [
                Argument {
                    name: "maxpool2d1_out1",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 4,
                            static_shape: Some(
                                [
                                    Some(
                                        1,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        8,
                                    ),
                                    Some(
                                        8,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            config: MaxPool2dConfig {
                kernel_size: [
                    2,
                    2,
                ],
                strides: [
                    2,
                    2,
                ],
                padding: Valid,
                dilation: [
                    1,
                    1,
                ],
                ceil_mode: false,
                auto_pad: NotSet,
            },
        },
    )
    "#);
}

#[test]
fn min() {
    let graph = load_model("opset_01.onnx");
    let node = find_node(&graph, "min");
    insta::assert_snapshot!(format!("{node:#?}"), @r#"
    Min(
        MinNode {
            name: "min1",
            inputs: [
                Argument {
                    name: "min_a",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
                Argument {
                    name: "min_b",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            outputs: [
                Argument {
                    name: "min1_out1",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
        },
    )
    "#);
}

#[test]
fn not_op() {
    let graph = load_model("opset_01.onnx");
    let node = find_node(&graph, "not");
    insta::assert_snapshot!(format!("{node:#?}"), @r#"
    Not(
        NotNode {
            name: "not1",
            inputs: [
                Argument {
                    name: "not_input",
                    ty: Tensor(
                        TensorType {
                            dtype: Bool,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            outputs: [
                Argument {
                    name: "not1_out1",
                    ty: Tensor(
                        TensorType {
                            dtype: Bool,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
        },
    )
    "#);
}

#[test]
fn or_op() {
    let graph = load_model("opset_01.onnx");
    let node = find_node(&graph, "or");
    insta::assert_snapshot!(format!("{node:#?}"), @r#"
    Or(
        OrNode {
            name: "or1",
            inputs: [
                Argument {
                    name: "or_a",
                    ty: Tensor(
                        TensorType {
                            dtype: Bool,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
                Argument {
                    name: "or_b",
                    ty: Tensor(
                        TensorType {
                            dtype: Bool,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            outputs: [
                Argument {
                    name: "or1_out1",
                    ty: Tensor(
                        TensorType {
                            dtype: Bool,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
        },
    )
    "#);
}

#[test]
fn pow() {
    let graph = load_model("opset_01.onnx");
    let node = find_node(&graph, "pow");
    insta::assert_snapshot!(format!("{node:#?}"), @r#"
    Pow(
        PowNode {
            name: "pow1",
            inputs: [
                Argument {
                    name: "pow_a",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
                Argument {
                    name: "pow_b",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            outputs: [
                Argument {
                    name: "pow1_out1",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
        },
    )
    "#);
}

#[test]
fn random_normal() {
    let graph = load_model("opset_01.onnx");
    let node = find_node(&graph, "randomnormal");
    insta::assert_snapshot!(format!("{node:#?}"), @r#"
    RandomNormal(
        RandomNormalNode {
            name: "randomnormal1",
            inputs: [],
            outputs: [
                Argument {
                    name: "randomnormal1_out1",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 2,
                            static_shape: None,
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            config: RandomNormalConfig {
                mean: 0.0,
                scale: 1.0,
                shape: [
                    2,
                    3,
                ],
            },
        },
    )
    "#);
}

#[test]
fn random_normal_like() {
    let graph = load_model("opset_01.onnx");
    let node = find_node(&graph, "randomnormallike");
    insta::assert_snapshot!(format!("{node:#?}"), @r#"
    RandomNormalLike(
        RandomNormalLikeNode {
            name: "randomnormallike1",
            inputs: [
                Argument {
                    name: "randomnormallike_input",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 2,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            outputs: [
                Argument {
                    name: "randomnormallike1_out1",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 2,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            config: RandomNormalLikeConfig {
                mean: 0.0,
                scale: 1.0,
            },
        },
    )
    "#);
}

#[test]
fn random_uniform() {
    let graph = load_model("opset_01.onnx");
    let node = find_node(&graph, "randomuniform");
    insta::assert_snapshot!(format!("{node:#?}"), @r#"
    RandomUniform(
        RandomUniformNode {
            name: "randomuniform1",
            inputs: [],
            outputs: [
                Argument {
                    name: "randomuniform1_out1",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 2,
                            static_shape: None,
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            config: RandomUniformConfig {
                low: 0.0,
                high: 1.0,
                shape: [
                    2,
                    3,
                ],
            },
        },
    )
    "#);
}

#[test]
fn random_uniform_like() {
    let graph = load_model("opset_01.onnx");
    let node = find_node(&graph, "randomuniformlike");
    insta::assert_snapshot!(format!("{node:#?}"), @r#"
    RandomUniformLike(
        RandomUniformLikeNode {
            name: "randomuniformlike1",
            inputs: [
                Argument {
                    name: "randomuniformlike_input",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 2,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            outputs: [
                Argument {
                    name: "randomuniformlike1_out1",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 2,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            config: RandomUniformLikeConfig {
                low: 0.0,
                high: 1.0,
            },
        },
    )
    "#);
}

#[test]
fn selu() {
    let graph = load_model("opset_01.onnx");
    let node = find_node(&graph, "selu");
    insta::assert_snapshot!(format!("{node:#?}"), @r#"
    Selu(
        SeluNode {
            name: "selu1",
            inputs: [
                Argument {
                    name: "selu_input",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            outputs: [
                Argument {
                    name: "selu1_out1",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            config: SeluConfig {
                alpha: 1.6732631921768188,
                gamma: 1.0507010221481323,
            },
        },
    )
    "#);
}

#[test]
fn shape() {
    let graph = load_model("opset_01.onnx");
    let node = find_node(&graph, "shape");
    insta::assert_snapshot!(format!("{node:#?}"), @r#"
    Shape(
        ShapeNode {
            name: "shape1",
            inputs: [
                Argument {
                    name: "shape_input",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            outputs: [
                Argument {
                    name: "shape1_out1",
                    ty: Shape(
                        3,
                    ),
                    value_source: Dynamic,
                },
            ],
            config: ShapeConfig {
                start: 0,
                end: 3,
            },
        },
    )
    "#);
}

#[test]
fn size() {
    let graph = load_model("opset_01.onnx");
    let node = find_node(&graph, "size");
    insta::assert_snapshot!(format!("{node:#?}"), @r#"
    Size(
        SizeNode {
            name: "size1",
            inputs: [
                Argument {
                    name: "size_input",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            outputs: [
                Argument {
                    name: "size1_out1",
                    ty: Scalar(
                        I64,
                    ),
                    value_source: Dynamic,
                },
            ],
        },
    )
    "#);
}

#[test]
fn softplus() {
    let graph = load_model("opset_01.onnx");
    let node = find_node(&graph, "softplus");
    insta::assert_snapshot!(format!("{node:#?}"), @r#"
    Softplus(
        SoftplusNode {
            name: "softplus1",
            inputs: [
                Argument {
                    name: "softplus_input",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            outputs: [
                Argument {
                    name: "softplus1_out1",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
        },
    )
    "#);
}

#[test]
fn softsign() {
    let graph = load_model("opset_01.onnx");
    let node = find_node(&graph, "softsign");
    insta::assert_snapshot!(format!("{node:#?}"), @r#"
    Softsign(
        SoftsignNode {
            name: "softsign1",
            inputs: [
                Argument {
                    name: "softsign_input",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            outputs: [
                Argument {
                    name: "softsign1_out1",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
        },
    )
    "#);
}

#[test]
fn space_to_depth() {
    let graph = load_model("opset_01.onnx");
    let node = find_node(&graph, "spacetodepth");
    insta::assert_snapshot!(format!("{node:#?}"), @r#"
    SpaceToDepth(
        SpaceToDepthNode {
            name: "spacetodepth1",
            inputs: [
                Argument {
                    name: "spacetodepth_input",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 4,
                            static_shape: Some(
                                [
                                    Some(
                                        1,
                                    ),
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        4,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            outputs: [
                Argument {
                    name: "spacetodepth1_out1",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 4,
                            static_shape: Some(
                                [
                                    Some(
                                        1,
                                    ),
                                    Some(
                                        8,
                                    ),
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        2,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            config: SpaceToDepthConfig {
                block_size: 2,
            },
        },
    )
    "#);
}

#[test]
fn transpose() {
    let graph = load_model("opset_01.onnx");
    let node = find_node(&graph, "transpose");
    insta::assert_snapshot!(format!("{node:#?}"), @r#"
    Transpose(
        TransposeNode {
            name: "transpose1",
            inputs: [
                Argument {
                    name: "transpose_input",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            outputs: [
                Argument {
                    name: "transpose1_out1",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        4,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        2,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            config: TransposeConfig {
                perm: [
                    2,
                    1,
                    0,
                ],
            },
        },
    )
    "#);
}

#[test]
fn xor_op() {
    let graph = load_model("opset_01.onnx");
    let node = find_node(&graph, "xor");
    insta::assert_snapshot!(format!("{node:#?}"), @r#"
    Xor(
        XorNode {
            name: "xor1",
            inputs: [
                Argument {
                    name: "xor_a",
                    ty: Tensor(
                        TensorType {
                            dtype: Bool,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
                Argument {
                    name: "xor_b",
                    ty: Tensor(
                        TensorType {
                            dtype: Bool,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            outputs: [
                Argument {
                    name: "xor1_out1",
                    ty: Tensor(
                        TensorType {
                            dtype: Bool,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
        },
    )
    "#);
}

/// Ops that require min_opset > 1: Abs, Add, ArgMax, ArgMin, AveragePool, BatchNormalization, Ceil, Clip, Concat, Div, Equal, Exp, Floor, Gemm, Greater, HardSigmoid, Hardmax, InstanceNormalization, LeakyRelu, Less, Log, LogSoftmax, Mean, Mul, Neg, PRelu, Pad, Reciprocal, ReduceL1, ReduceL2, ReduceLogSum, ReduceLogSumExp, ReduceMax, ReduceMean, ReduceMin, ReduceProd, ReduceSum, ReduceSumSquare, Relu, Reshape, Sigmoid, Slice, Softmax, Split, Sqrt, Squeeze, Sub, Sum, Tanh, Tile, TopK, Unsqueeze
#[test]
fn unsupported_ops_fail() {
    let result = load_model_result("opset_01_unsupported.onnx");
    assert!(
        result.is_err(),
        "expected parse failure for unsupported ops at opset 1"
    );
}
