//! Opset 10 compliance tests.
//!
//! Auto-generated by gen_rust_tests.py. Edit the generator, not this file.

use super::helpers::*;

/// Dropout is eliminated during post-processing (no-op).
/// Verify the model parses without error.
#[test]
fn dropout() {
    let _graph = load_model("opset_10.onnx");
}

#[test]
fn is_inf() {
    let graph = load_model("opset_10.onnx");
    let node = find_node(&graph, "isinf");
    insta::assert_snapshot!(format!("{node:#?}"), @r#"
    IsInf(
        IsInfNode {
            name: "isinf1",
            inputs: [
                Argument {
                    name: "isinf_input",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 2,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            outputs: [
                Argument {
                    name: "isinf1_out1",
                    ty: Tensor(
                        TensorType {
                            dtype: Bool,
                            rank: 2,
                            static_shape: None,
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            config: IsInfConfig {
                detect_negative: true,
                detect_positive: true,
            },
        },
    )
    "#);
}

#[test]
fn mat_mul_integer() {
    let graph = load_model("opset_10.onnx");
    let node = find_node(&graph, "matmulinteger");
    insta::assert_snapshot!(format!("{node:#?}"), @r#"
    MatMulInteger(
        MatMulIntegerNode {
            name: "matmulinteger1",
            inputs: [
                Argument {
                    name: "matmulinteger_a",
                    ty: Tensor(
                        TensorType {
                            dtype: U8,
                            rank: 2,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
                Argument {
                    name: "matmulinteger_b",
                    ty: Tensor(
                        TensorType {
                            dtype: U8,
                            rank: 2,
                            static_shape: Some(
                                [
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            outputs: [
                Argument {
                    name: "matmulinteger1_out1",
                    ty: Tensor(
                        TensorType {
                            dtype: I32,
                            rank: 2,
                            static_shape: None,
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
        },
    )
    "#);
}

#[test]
fn max_pool() {
    let graph = load_model("opset_10.onnx");
    let node = find_node(&graph, "maxpool2d");
    insta::assert_snapshot!(format!("{node:#?}"), @r#"
    MaxPool2d(
        MaxPool2dNode {
            name: "maxpool2d1",
            inputs: [
                Argument {
                    name: "maxpool_input",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 4,
                            static_shape: Some(
                                [
                                    Some(
                                        1,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        8,
                                    ),
                                    Some(
                                        8,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            outputs: [
                Argument {
                    name: "maxpool2d1_out1",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 4,
                            static_shape: Some(
                                [
                                    Some(
                                        1,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        8,
                                    ),
                                    Some(
                                        8,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            config: MaxPool2dConfig {
                kernel_size: [
                    2,
                    2,
                ],
                strides: [
                    2,
                    2,
                ],
                padding: Valid,
                dilation: [
                    1,
                    1,
                ],
                ceil_mode: false,
                auto_pad: NotSet,
            },
        },
    )
    "#);
}

#[test]
fn mod_op() {
    let graph = load_model("opset_10.onnx");
    let node = find_node(&graph, "mod");
    insta::assert_snapshot!(format!("{node:#?}"), @r#"
    Mod(
        ModNode {
            name: "mod1",
            inputs: [
                Argument {
                    name: "mod_a",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
                Argument {
                    name: "mod_b",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            outputs: [
                Argument {
                    name: "mod1_out1",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            config: ModConfig {
                fmod: false,
            },
        },
    )
    "#);
}

#[test]
fn slice() {
    let graph = load_model("opset_10.onnx");
    let node = find_node(&graph, "slice");
    insta::assert_snapshot!(format!("{node:#?}"), @r#"
    Slice(
        SliceNode {
            name: "slice1",
            inputs: [
                Argument {
                    name: "slice_input",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 2,
                            static_shape: Some(
                                [
                                    Some(
                                        4,
                                    ),
                                    Some(
                                        6,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
                Argument {
                    name: "",
                    ty: Tensor(
                        TensorType {
                            dtype: I64,
                            rank: 1,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Static(
                        0,
                    ),
                },
                Argument {
                    name: "",
                    ty: Tensor(
                        TensorType {
                            dtype: I64,
                            rank: 1,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Static(
                        1,
                    ),
                },
                Argument {
                    name: "",
                    ty: Tensor(
                        TensorType {
                            dtype: I64,
                            rank: 1,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Static(
                        2,
                    ),
                },
            ],
            outputs: [
                Argument {
                    name: "slice1_out1",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 2,
                            static_shape: Some(
                                [
                                    Some(
                                        4,
                                    ),
                                    Some(
                                        6,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            config: SliceConfig {
                starts: Static(
                    [
                        0,
                        1,
                    ],
                ),
                ends: Static(
                    [
                        2,
                        4,
                    ],
                ),
                axes: Some(
                    Static(
                        [
                            0,
                            1,
                        ],
                    ),
                ),
                steps: Some(
                    Static(
                        [
                            1,
                            1,
                        ],
                    ),
                ),
            },
        },
    )
    "#);
}

#[test]
fn thresholded_relu() {
    let graph = load_model("opset_10.onnx");
    let node = find_node(&graph, "thresholdedrelu");
    insta::assert_snapshot!(format!("{node:#?}"), @r#"
    ThresholdedRelu(
        ThresholdedReluNode {
            name: "thresholdedrelu1",
            inputs: [
                Argument {
                    name: "thresholdedrelu_input",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            outputs: [
                Argument {
                    name: "thresholdedrelu1_out1",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 3,
                            static_shape: Some(
                                [
                                    Some(
                                        2,
                                    ),
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            config: ThresholdedReluConfig {
                alpha: 1.0,
            },
        },
    )
    "#);
}

#[test]
fn top_k() {
    let graph = load_model("opset_10.onnx");
    let node = find_node(&graph, "topk");
    insta::assert_snapshot!(format!("{node:#?}"), @r#"
    TopK(
        TopKNode {
            name: "topk1",
            inputs: [
                Argument {
                    name: "topk_input",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 2,
                            static_shape: Some(
                                [
                                    Some(
                                        3,
                                    ),
                                    Some(
                                        4,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Dynamic,
                },
                Argument {
                    name: "",
                    ty: Tensor(
                        TensorType {
                            dtype: I64,
                            rank: 1,
                            static_shape: Some(
                                [
                                    Some(
                                        1,
                                    ),
                                ],
                            ),
                        },
                    ),
                    value_source: Static(
                        3,
                    ),
                },
            ],
            outputs: [
                Argument {
                    name: "topk1_out1",
                    ty: Tensor(
                        TensorType {
                            dtype: F32,
                            rank: 2,
                            static_shape: None,
                        },
                    ),
                    value_source: Dynamic,
                },
                Argument {
                    name: "topk1_out2",
                    ty: Tensor(
                        TensorType {
                            dtype: I64,
                            rank: 2,
                            static_shape: None,
                        },
                    ),
                    value_source: Dynamic,
                },
            ],
            config: TopKConfig {
                axis: 1,
                k: Static(
                    2,
                ),
            },
        },
    )
    "#);
}

/// Ops that require min_opset > 10: AveragePool, Resize
#[test]
fn unsupported_ops_fail() {
    let result = load_model_result("opset_10_unsupported.onnx");
    assert!(
        result.is_err(),
        "expected parse failure for unsupported ops at opset 10"
    );
}
